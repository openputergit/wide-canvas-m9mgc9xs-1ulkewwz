<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition Attendance</title>
    <script src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .video-container {
            position: relative;
            min-height: 300px;
            background: #f0f0f0;
            border-radius: 8px;
        }
        #video, #canvas {
            border-radius: 8px;
            position: absolute;
            top: 0;
            left: 0;
        }
        canvas {
            z-index: 10;
        }
        .capture-angles {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }
        .angle-btn {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-lg">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-emerald-600 text-center mb-2">Face Recognition Attendance</h1>
            <p class="text-center text-gray-600 mb-6">Please identify yourself using the detect button</p>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button id="usersBtn" class="p-6 bg-gray-50 rounded-lg hover:bg-gray-100 transition duration-300 flex flex-col items-center">
                    <i class="bi bi-people text-3xl mb-2 text-emerald-600"></i>
                    <span class="text-gray-700">Users</span>
                </button>
                
                <button id="detectBtn" class="p-6 bg-gray-50 rounded-lg hover:bg-gray-100 transition duration-300 flex flex-col items-center">
                    <i class="bi bi-camera text-3xl mb-2 text-emerald-600"></i>
                    <span class="text-gray-700">Detect</span>
                </button>

                <button id="logsBtn" class="p-6 bg-gray-50 rounded-lg hover:bg-gray-100 transition duration-300 flex flex-col items-center">
                    <i class="bi bi-journal-text text-3xl mb-2 text-emerald-600"></i>
                    <span class="text-gray-700">Logs</span>
                </button>

                <button id="settingsBtn" class="p-6 bg-gray-50 rounded-lg hover:bg-gray-100 transition duration-300 flex flex-col items-center">
                    <i class="bi bi-gear text-3xl mb-2 text-emerald-600"></i>
                    <span class="text-gray-700">Settings</span>
                </button>
            </div>

            <div id="videoContainer" class="video-container hidden">
                <video id="video" width="100%" height="300" autoplay muted></video>
                <div class="absolute top-2 right-2 z-20 flex gap-2">
                    <button id="captureBtn" class="bg-emerald-500 text-white p-2 rounded-full hover:bg-emerald-600">
                        <i class="bi bi-camera-fill"></i>
                    </button>
                    <button id="closeVideo" class="bg-red-500 text-white p-2 rounded-full hover:bg-red-600">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>

            <div id="captureAnglesContainer" class="hidden mt-4">
                <h3 class="text-lg font-semibold mb-4">Capture Multiple Angles</h3>
                <p class="text-sm text-gray-600 mb-2">Please capture your face from different angles for better recognition</p>
                <div class="capture-angles">
                    <button id="frontAngle" class="angle-btn bg-emerald-500 text-white hover:bg-emerald-600">Front</button>
                    <button id="leftAngle" class="angle-btn bg-gray-200 text-gray-800 hover:bg-gray-300">Left</button>
                    <button id="rightAngle" class="angle-btn bg-gray-200 text-gray-800 hover:bg-gray-300">Right</button>
                </div>
                <div id="anglePreviewContainer" class="flex justify-center gap-2 mt-4">
                    <div class="w-1/3 h-20 bg-gray-100 rounded flex justify-center items-center" id="frontPreview">
                        <span class="text-xs text-gray-500">Front</span>
                    </div>
                    <div class="w-1/3 h-20 bg-gray-100 rounded flex justify-center items-center" id="leftPreview">
                        <span class="text-xs text-gray-500">Left</span>
                    </div>
                    <div class="w-1/3 h-20 bg-gray-100 rounded flex justify-center items-center" id="rightPreview">
                        <span class="text-xs text-gray-500">Right</span>
                    </div>
                </div>
                <button id="proceedToInfo" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md mt-4 hover:bg-blue-600 transition duration-300 hidden">
                    Proceed to Information
                </button>
            </div>

            <!-- User Info Form (Hidden by default) -->
            <div id="userInfoForm" class="hidden mt-4">
                <h3 class="text-lg font-semibold mb-4">Add User Information</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="userName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Class</label>
                        <input type="text" id="userClass" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                    </div>
                    <button id="saveUserInfo" class="w-full bg-emerald-500 text-white py-2 px-4 rounded-md hover:bg-emerald-600 transition duration-300">
                        Save Information
                    </button>
                </div>
            </div>

            <!-- Users Section (Hidden by default) -->
            <div id="usersSection" class="hidden mt-4">
                <h3 class="text-lg font-semibold mb-4">Registered Users</h3>
                <p id="noUsersMessage" class="text-center text-gray-500 py-4">No registered users found</p>
                <ul id="usersList" class="divide-y divide-gray-200">
                    <!-- Users will be dynamically added here -->
                </ul>
            </div>

            <!-- Logs Section (Hidden by default) -->
            <div id="logsSection" class="hidden mt-4">
                <h3 class="text-lg font-semibold mb-4">Attendance Logs</h3>
                <div class="mb-4 flex justify-between items-center">
                    <div>
                        <button id="exportExcel" class="bg-green-500 text-white py-1 px-3 rounded-md text-sm hover:bg-green-600">
                            <i class="bi bi-file-earmark-excel mr-1"></i> Export to Excel
                        </button>
                    </div>
                    <div>
                        <select id="filterLogs" class="text-sm border rounded p-1">
                            <option value="all">All Logs</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                        </select>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-lg p-3 max-h-60 overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Class</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Check In</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Check Out</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody" class="divide-y divide-gray-200">
                            <!-- Logs will be dynamically added here -->
                        </tbody>
                    </table>
                    <p id="noLogsMessage" class="text-center text-gray-500 py-4">No logs found</p>
                </div>
            </div>

            <!-- Settings Section (Hidden by default) -->
            <div id="settingsSection" class="hidden mt-4">
                <h3 class="text-lg font-semibold mb-4">Edit User Information</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Select User</label>
                    <select id="userSelect" class="w-full p-2 border rounded-md">
                        <option value="">Select a user to edit...</option>
                    </select>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="editUserName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Class</label>
                        <input type="text" id="editUserClass" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" required>
                    </div>
                    <div class="flex gap-2">
                        <button id="updateUserInfo" class="flex-1 bg-amber-500 text-white py-2 px-4 rounded-md hover:bg-amber-600 transition duration-300">
                            Update Information
                        </button>
                        <button id="deleteUser" class="bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition duration-300">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recognition Status -->
            <div id="recognitionStatus" class="hidden mt-4 p-4 rounded-lg text-center">
                <div class="animate-pulse mb-2">
                    <i class="bi bi-search text-3xl text-blue-500"></i>
                </div>
                <p class="text-lg font-medium" id="statusMessage">Scanning...</p>
                <p class="text-sm text-gray-500" id="statusDetail">Please look at the camera</p>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const videoContainer = document.getElementById('videoContainer');
        const detectBtn = document.getElementById('detectBtn');
        const closeVideo = document.getElementById('closeVideo');
        const captureBtn = document.getElementById('captureBtn');
        const userInfoForm = document.getElementById('userInfoForm');
        const saveUserInfo = document.getElementById('saveUserInfo');
        const usersSection = document.getElementById('usersSection');
        const usersList = document.getElementById('usersList');
        const noUsersMessage = document.getElementById('noUsersMessage');
        const logsSection = document.getElementById('logsSection');
        const logsTableBody = document.getElementById('logsTableBody');
        const noLogsMessage = document.getElementById('noLogsMessage');
        const settingsSection = document.getElementById('settingsSection');
        const updateUserInfo = document.getElementById('updateUserInfo');
        const userSelect = document.getElementById('userSelect');
        const deleteUser = document.getElementById('deleteUser');
        const captureAnglesContainer = document.getElementById('captureAnglesContainer');
        const frontAngle = document.getElementById('frontAngle');
        const leftAngle = document.getElementById('leftAngle');
        const rightAngle = document.getElementById('rightAngle');
        const proceedToInfo = document.getElementById('proceedToInfo');
        const frontPreview = document.getElementById('frontPreview');
        const leftPreview = document.getElementById('leftPreview');
        const rightPreview = document.getElementById('rightPreview');
        const recognitionStatus = document.getElementById('recognitionStatus');
        const statusMessage = document.getElementById('statusMessage');
        const statusDetail = document.getElementById('statusDetail');
        const exportExcel = document.getElementById('exportExcel');
        const filterLogs = document.getElementById('filterLogs');

        let userData = [];
        let currentUser = null;
        let attendanceLogs = [];
        let capturedAngles = {
            front: null,
            left: null,
            right: null
        };
        let recognitionMode = false;
        let currentStream = null;

        // Load saved data from localStorage if available
        function loadSavedData() {
            const savedUsers = localStorage.getItem('faceRecognitionUsers');
            const savedLogs = localStorage.getItem('faceRecognitionLogs');
            
            if (savedUsers) {
                userData = JSON.parse(savedUsers);
                updateUsersList();
                updateUserSelect();
            }
            
            if (savedLogs) {
                attendanceLogs = JSON.parse(savedLogs);
                updateLogsTable();
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('faceRecognitionUsers', JSON.stringify(userData));
            localStorage.setItem('faceRecognitionLogs', JSON.stringify(attendanceLogs));
        }

        // Initialize face-api.js
        Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights'),
            faceapi.nets.faceLandmark68Net.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights'),
            faceapi.nets.faceRecognitionNet.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights'),
            faceapi.nets.faceExpressionNet.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights'),
            faceapi.nets.ssdMobilenetv1.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights')
        ]).then(() => {
            console.log('Face detection models loaded');
            loadSavedData();
        });

        function startVideo(recognitionMode = false) {
            if (currentStream) {
                const tracks = currentStream.getTracks();
                tracks.forEach(track => track.stop());
            }

            videoContainer.classList.remove('hidden');
            userInfoForm.classList.add('hidden');
            usersSection.classList.add('hidden');
            logsSection.classList.add('hidden');
            settingsSection.classList.add('hidden');
            captureAnglesContainer.classList.add('hidden');
            
            if (recognitionMode) {
                recognitionStatus.classList.remove('hidden');
                statusMessage.textContent = 'Scanning...';
                statusDetail.textContent = 'Please look at the camera';
                captureBtn.classList.add('hidden');
            } else {
                recognitionStatus.classList.add('hidden');
                captureBtn.classList.remove('hidden');
            }
            
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    currentStream = stream;
                    video.srcObject = stream;
                    video.play();
                    
                    if (recognitionMode) {
                        startFaceRecognition();
                    }
                })
                .catch(err => {
                    console.error('Error accessing camera:', err);
                    alert('Could not access camera. Please ensure camera permissions are granted.');
                });
        }

        // Start face recognition for attendance
        function startFaceRecognition() {
            if (userData.length === 0) {
                statusMessage.textContent = 'No registered users';
                statusDetail.textContent = 'Please register users first';
                return;
            }
            
            const canvas = document.createElement('canvas');
            canvas.id = 'canvas';
            canvas.width = video.width;
            canvas.height = video.height;
            videoContainer.appendChild(canvas);
            
            // Create face descriptors for registered users
            const labeledDescriptors = [];
            for (const user of userData) {
                if (user.descriptors && user.descriptors.length > 0) {
                    labeledDescriptors.push(
                        new faceapi.LabeledFaceDescriptors(
                            user.id, 
                            user.descriptors.map(desc => new Float32Array(desc))
                        )
                    );
                }
            }
            
            const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors);
            
            const intervalId = setInterval(async () => {
                if (!video.srcObject) {
                    clearInterval(intervalId);
                    return;
                }
                
                const detections = await faceapi.detectAllFaces(video)
                    .withFaceLandmarks()
                    .withFaceDescriptors();
                
                const resizedDetections = faceapi.resizeResults(detections, {
                    width: video.width,
                    height: video.height
                });
                
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                if (resizedDetections.length > 0) {
                    resizedDetections.forEach(detection => {
                        const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                        const box = detection.detection.box;
                        
                        // Draw box around face
                        const drawBox = new faceapi.draw.DrawBox(box, { 
                            label: bestMatch.toString(),
                            boxColor: bestMatch.distance < 0.6 ? 'green' : 'red'
                        });
                        drawBox.draw(canvas);
                        
                        if (bestMatch.distance < 0.6) {
                            const userId = bestMatch.label;
                            if (userId !== 'unknown') {
                                const matchedUser = userData.find(u => u.id === userId);
                                
                                // Check if already logged today
                                const today = new Date().toDateString();
                                const existingLog = attendanceLogs.find(log => 
                                    log.userId === userId && new Date(log.checkIn).toDateString() === today && !log.checkOut
                                );
                                
                                if (existingLog) {
                                    // User already checked in, this is check out
                                    existingLog.checkOut = new Date().toISOString();
                                    statusMessage.textContent = 'Check Out Successful';
                                    statusDetail.textContent = `Goodbye, ${matchedUser.name}!`;
                                } else {
                                    const newLog = {
                                        userId: userId,
                                        name: matchedUser.name,
                                        class: matchedUser.class,
                                        checkIn: new Date().toISOString(),
                                        checkOut: null
                                    };
                                    attendanceLogs.push(newLog);
                                    statusMessage.textContent = 'Check In Successful';
                                    statusDetail.textContent = `Welcome, ${matchedUser.name}!`;
                                }
                                
                                saveData();
                                updateLogsTable();
                                
                                // Stop recognition after successful match
                                setTimeout(() => {
                                    clearInterval(intervalId);
                                    if (canvas.parentNode) {
                                        canvas.parentNode.removeChild(canvas);
                                    }
                                    closeCamera();
                                }, 2000);
                            }
                        }
                    });
                }
            }, 100);
        }

        // Update the users list in the Users section
        function updateUsersList() {
            if (userData.length === 0) {
                noUsersMessage.classList.remove('hidden');
                usersList.classList.add('hidden');
                return;
            }
            
            noUsersMessage.classList.add('hidden');
            usersList.classList.remove('hidden');
            usersList.innerHTML = '';
            
            userData.forEach(user => {
                const userItem = document.createElement('li');
                userItem.className = 'py-3 flex justify-between items-center';
                
                const userInfo = document.createElement('div');
                userInfo.className = 'flex items-center';
                
                // User image/avatar
                const userImage = document.createElement('div');
                if (user.frontImage) {
                    userImage.innerHTML = `<img src="${user.frontImage}" class="h-12 w-12 rounded-full object-cover border border-gray-200">`;
                } else {
                    userImage.innerHTML = `<div class="h-12 w-12 rounded-full bg-gray-200 flex items-center justify-center"><i class="bi bi-person text-gray-500"></i></div>`;
                }
                
                // User details
                const userDetails = document.createElement('div');
                userDetails.className = 'ml-3';
                userDetails.innerHTML = `
                    <p class="text-sm font-medium text-gray-900">${user.name}</p>
                    <p class="text-xs text-gray-500">${user.class}</p>
                `;
                
                userInfo.appendChild(userImage);
                userInfo.appendChild(userDetails);
                userItem.appendChild(userInfo);
                usersList.appendChild(userItem);
            });
        }

        // Update logs table
        function updateLogsTable(filter = 'all') {
            if (attendanceLogs.length === 0) {
                noLogsMessage.classList.remove('hidden');
                logsTableBody.innerHTML = '';
                return;
            }
            
            noLogsMessage.classList.add('hidden');
            logsTableBody.innerHTML = '';
            
            // Apply filter
            let filteredLogs = [...attendanceLogs];
            const today = new Date().toDateString();
            
            if (filter === 'today') {
                filteredLogs = filteredLogs.filter(log => 
                    new Date(log.checkIn).toDateString() === today
                );
            } else if (filter === 'week') {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                filteredLogs = filteredLogs.filter(log => 
                    new Date(log.checkIn) >= weekAgo
                );
            }
            
            if (filteredLogs.length === 0) {
                noLogsMessage.classList.remove('hidden');
                return;
            }
            
            // Sort logs by check-in time (newest first)
            filteredLogs.sort((a, b) => new Date(b.checkIn) - new Date(a.checkIn));
            
            filteredLogs.forEach(log => {
                const row = document.createElement('tr');
                row.className = 'bg-white';
                
                const formatTime = (timestamp) => {
                    if (!timestamp) return '—';
                    const date = new Date(timestamp);
                    return date.toLocaleString('en-US', { 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };
                
                row.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${log.name}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${log.class}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${formatTime(log.checkIn)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${formatTime(log.checkOut)}</td>
                `;
                
                logsTableBody.appendChild(row);
            });
        }

        // Update users in settings dropdown
        function updateUserSelect() {
            userSelect.innerHTML = '<option value="">Select a user to edit...</option>';
            
            userData.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.class})`;
                userSelect.appendChild(option);
            });
        }

        // Capture user images from different angles
        async function captureUserImage(angle) {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const imageData = canvas.toDataURL('image/jpeg');
            
            // Store image data for the specific angle
            capturedAngles[angle] = imageData;
            
            // Update preview
            const preview = document.getElementById(`${angle}Preview`);
            preview.innerHTML = `<img src="${imageData}" class="h-full w-full object-cover rounded">`;
            
            // Mark button as captured
            document.getElementById(`${angle}Angle`).className = 'angle-btn bg-green-500 text-white hover:bg-green-600';
            
            // Extract face descriptor for this angle
            try {
                const detection = await faceapi.detectSingleFace(canvas)
                    .withFaceLandmarks()
                    .withFaceDescriptor();
                
                if (detection) {
                    if (!capturedAngles.descriptors) {
                        capturedAngles.descriptors = [];
                    }
                    
                    capturedAngles.descriptors.push(Array.from(detection.descriptor));
                    
                    // Show proceed button if all angles are captured and at least one has a valid descriptor
                    if (capturedAngles.front && capturedAngles.left && capturedAngles.right && capturedAngles.descriptors.length > 0) {
                        proceedToInfo.classList.remove('hidden');
                    }
                }
            } catch (err) {
                console.error('Error extracting face descriptor:', err);
            }
        }

        // Generate unique ID
        function generateId() {
            return 'user_' + new Date().getTime() + '_' + Math.random().toString(36).substring(2, 9);
        }

        // Close camera
        function closeCamera() {
            if (video.srcObject) {
                const stream = video.srcObject;
                const tracks = stream.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }
            
            const canvas = document.getElementById('canvas');
            if (canvas) {
                canvas.parentNode.removeChild(canvas);
            }
            
            currentStream = null;
            videoContainer.classList.add('hidden');
            recognitionStatus.classList.add('hidden');
        }

        // Export attendance to Excel
        function exportToExcel() {
            if (attendanceLogs.length === 0) {
                alert('No attendance logs to export');
                return;
            }
            
            // Create CSV content
            let csvContent = 'data:text/csv;charset=utf-8,';
            csvContent += 'Name,Class,Check In,Check Out\n';
            
            attendanceLogs.forEach(log => {
                const checkIn = log.checkIn ? new Date(log.checkIn).toLocaleString() : '';
                const checkOut = log.checkOut ? new Date(log.checkOut).toLocaleString() : '';
                const row = `${log.name},${log.class},${checkIn},${checkOut}`;
                csvContent += row + '\n';
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `attendance_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // EVENT LISTENERS
        
        // Detect button - Start video for recognition
        detectBtn.addEventListener('click', () => {
            recognitionMode = true;
            startVideo(true);
        });

        // Capture button - For new user registration
        captureBtn.addEventListener('click', () => {
            videoContainer.classList.add('hidden');
            captureAnglesContainer.classList.remove('hidden');
            
            // Reset angle captures
            capturedAngles = { front: null, left: null, right: null };
            frontPreview.innerHTML = '<span class="text-xs text-gray-500">Front</span>';
            leftPreview.innerHTML = '<span class="text-xs text-gray-500">Left</span>';
            rightPreview.innerHTML = '<span class="text-xs text-gray-500">Right</span>';
            
            frontAngle.className = 'angle-btn bg-emerald-500 text-white hover:bg-emerald-600';
            leftAngle.className = 'angle-btn bg-gray-200 text-gray-800 hover:bg-gray-300';
            rightAngle.className = 'angle-btn bg-gray-200 text-gray-800 hover:bg-gray-300';
            
            proceedToInfo.classList.add('hidden');
        });

        // Angle capture buttons
        frontAngle.addEventListener('click', () => captureUserImage('front'));
        leftAngle.addEventListener('click', () => captureUserImage('left'));
        rightAngle.addEventListener('click', () => captureUserImage('right'));

        // Proceed to info button
        proceedToInfo.addEventListener('click', () => {
            captureAnglesContainer.classList.add('hidden');
            userInfoForm.classList.remove('hidden');
            document.getElementById('userName').focus();
        });

        // Close video button
        closeVideo.addEventListener('click', closeCamera);

        // Save user info button
        saveUserInfo.addEventListener('click', () => {
            const name = document.getElementById('userName').value;
            const className = document.getElementById('userClass').value;
            
            if (name && className) {
                const userId = generateId();
                const newUser = {
                    id: userId,
                    name: name,
                    class: className,
                    frontImage: capturedAngles.front,
                    leftImage: capturedAngles.left,
                    rightImage: capturedAngles.right,
                    descriptors: capturedAngles.descriptors || [],
                    createdAt: new Date().toISOString()
                };
                
                userData.push(newUser);
                saveData();
                updateUsersList();
                updateUserSelect();
                
                // Clear form
                document.getElementById('userName').value = '';
                document.getElementById('userClass').value = '';
                userInfoForm.classList.add('hidden');
                
                // Show success message
                alert('User registered successfully!');
            } else {
                alert('Please fill in all required fields');
            }
        });

        // Users button
        document.getElementById('usersBtn').addEventListener('click', () => {
            usersSection.classList.remove('hidden');
            userInfoForm.classList.add('hidden');
            logsSection.classList.add('hidden');
            settingsSection.classList.add('hidden');
            videoContainer.classList.add('hidden');
            captureAnglesContainer.classList.add('hidden');
            recognitionStatus.classList.add('hidden');
            closeCamera();
            
            updateUsersList();
        });

        // Logs button
        document.getElementById('logsBtn').addEventListener('click', () => {
            logsSection.classList.remove('hidden');
            userInfoForm.classList.add('hidden');
            usersSection.classList.add('hidden');
            settingsSection.classList.add('hidden');
            videoContainer.classList.add('hidden');
            captureAnglesContainer.classList.add('hidden');
            recognitionStatus.classList.add('hidden');
            closeCamera();
            
            updateLogsTable(filterLogs.value);
        });

        // Settings button
        document.getElementById('settingsBtn').addEventListener('click', () => {
            settingsSection.classList.remove('hidden');
            userInfoForm.classList.add('hidden');
            usersSection.classList.add('hidden');
            logsSection.classList.add('hidden');
            videoContainer.classList.add('hidden');
            captureAnglesContainer.classList.add('hidden');
            recognitionStatus.classList.add('hidden');
            closeCamera();
        });

        // User selection in settings
        userSelect.addEventListener('change', () => {
            const userId = userSelect.value;
            if (userId) {
                const selectedUser = userData.find(user => user.id === userId);
                document.getElementById('editUserName').value = selectedUser.name;
                document.getElementById('editUserClass').value = selectedUser.class;
            } else {
                document.getElementById('editUserName').value = '';
                document.getElementById('editUserClass').value = '';
            }
        });

        // Update user info
        updateUserInfo.addEventListener('click', () => {
            const userId = userSelect.value;
            const name = document.getElementById('editUserName').value;
            const className = document.getElementById('editUserClass').value;
            
            if (userId && name && className) {
                const userIndex = userData.findIndex(user => user.id === userId);
                if (userIndex !== -1) {
                    userData[userIndex].name = name;
                    userData[userIndex].class = className;
                    
                    // Update attendance logs for this user
                    attendanceLogs.forEach(log => {
                        if (log.userId === userId) {
                            log.name = name;
                            log.class = className;
                        }
                    });
                    
                    saveData();
                    updateUsersList();
                    updateUserSelect();
                    updateLogsTable();
                    
                    alert('User information updated successfully!');
                }
            } else {
                alert('Please select a user and fill in all fields');
            }
        });

        // Delete user
        deleteUser.addEventListener('click', () => {
            const userId = userSelect.value;
            if (userId && confirm('Are you sure you want to delete this user?')) {
                userData = userData.filter(user => user.id !== userId);
                
                // Remove related logs
                attendanceLogs = attendanceLogs.filter(log => log.userId !== userId);
                
                saveData();
                updateUsersList();
                updateUserSelect();
                updateLogsTable();
                
                document.getElementById('editUserName').value = '';
                document.getElementById('editUserClass').value = '';
                
                alert('User deleted successfully!');
            }
        });

        // Export to Excel
        exportExcel.addEventListener('click', exportToExcel);

        // Filter logs
        filterLogs.addEventListener('change', () => {
            updateLogsTable(filterLogs.value);
        });

        // Process video frames for face detection
        video.addEventListener('play', () => {
            if (!recognitionMode) {
                const canvas = faceapi.createCanvasFromMedia(video);
                canvas.id = 'canvas';
                videoContainer.appendChild(canvas);
                
                const displaySize = { width: video.width, height: video.height };
                faceapi.matchDimensions(canvas, displaySize);
                
                const intervalId = setInterval(async () => {
                    if (!video.srcObject) {
                        clearInterval(intervalId);
                        if (canvas.parentNode) {
                            canvas.parentNode.removeChild(canvas);
                        }
                        return;
                    }
                    
                    const detections = await faceapi.detectAllFaces(video, 
                        new faceapi.TinyFaceDetectorOptions())
                        .withFaceLandmarks();
                    
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                    faceapi.draw.drawDetections(canvas, resizedDetections);
                    faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
                }, 100);
            }
        });
    </script>
<script>document.body.addEventListener('wheel', e => { if (!e.ctrlKey) return; e.preventDefault(); return }, { passive: false })</script>
	</body>
</html>